<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©èµ„ç”³è¯· - ç”¨æˆ·ç«¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        .form-card { max-width: 1000px; margin: 2rem auto; }
        .material-table-container { max-height: 400px; overflow-y: auto; margin-top: 1rem; }
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ–ï¼šè¾¹æ¡†æ¸…æ™°ã€hoveræ•ˆæœ */
        .material-table { width: 100%; border-collapse: collapse; }
        .material-table th, .material-table td { padding: 0.8rem; text-align: center; border: 1px solid #dee2e6; }
        .material-table th { background-color: #f8f9fa; font-weight: 500; }
        .material-table tbody tr:hover { background-color: #f8f9fa; }
        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="user-index.html">åº”æ€¥ç‰©èµ„è°ƒåº¦ç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#userNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="userNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="user-index.html">é¦–é¡µ</a></li>
                    <li class="nav-item"><a class="nav-link" href="user-disaster-report.html">ç¾æƒ…ä¸ŠæŠ¥</a></li>
                    <li class="nav-item"><a class="nav-link active" href="user-material-apply.html">ç‰©èµ„ç”³è¯·</a></li>
                    <li class="nav-item"><a class="nav-link" href="user-order-query.html">ç”³è¯·è¿›åº¦</a></li>
                    <li class="nav-item"><a class="nav-link" href="user-evaluation.html">è¯„ä»·åé¦ˆ</a></li>
                </ul>
                <span class="navbar-text me-3" id="userInfo"></span>
                <button class="btn btn-light" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </nav>

    <!-- è¡¨å•å¡ç‰‡ -->
    <div class="container">
        <div class="card form-card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">æ•‘æ´ç‰©èµ„ç”³è¯·</h5>
            </div>
            <div class="card-body">
                <form id="materialApplyForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="disasterSelect" class="form-label">å…³è”ç¾æƒ…ï¼ˆå¿…é€‰ï¼‰</label>
                            <select class="form-select" id="disasterSelect" name="disasterId" required>
                                <option value="">è¯·é€‰æ‹©å·²å®¡æ ¸é€šè¿‡çš„ç¾æƒ…</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="targetAddress" class="form-label">æ¥æ”¶åœ°å€</label>
                            <input type="text" class="form-control" id="targetAddress" name="targetAddress" required placeholder="ç‰©èµ„æ¥æ”¶è¯¦ç»†åœ°å€ï¼ˆå¦‚XXå¸‚XXå¿XXä¹¡XXæ‘å®‰ç½®ç‚¹ï¼‰">
                        </div>
                    </div>

                    <h5>å¯é€‰ç‰©èµ„åˆ—è¡¨ï¼ˆå‹¾é€‰åå¡«å†™ç”³è¯·æ•°é‡ï¼‰</h5>
                    <!-- è¡¨æ ¼å®¹å™¨ï¼šå¸¦æ»šåŠ¨æ¡ -->
                    <div class="material-table-container border rounded">
                        <table class="material-table">
                            <thead>
                                <tr>
                                    <th style="width: 7%;">é€‰æ‹©</th>
                                    <th style="width: 18%;">ç‰©èµ„åç§°</th>
                                    <th style="width: 12%;">ç‰©èµ„ç±»å‹</th>
                                    <th style="width: 12%;">ä¼˜å…ˆçº§</th>
                                    <th style="width: 10%;">åº“å­˜æ•°é‡</th>
                                    <th style="width: 10%;">è§„æ ¼</th>
                                    <th style="width: 15%;">å¤‡æ³¨</th>
                                    <th style="width: 16%;">ç”³è¯·æ•°é‡</th>
                                </tr>
                            </thead>
                            <tbody id="materialTableBody">
                                <!-- ç‰©èµ„æ•°æ®é€šè¿‡JSæ¸²æŸ“ -->
                            </tbody>
                        </table>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mt-4">æäº¤ç”³è¯·</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. å…¨å±€é…ç½®
        const apiBaseUrl = 'http://localhost:8080';

        // 2. åŠ è½½çŠ¶æ€æ§åˆ¶
        function showLoading(show) {
            const loadingEl = document.getElementById('loadingOverlay');
            loadingEl.style.display = show ? 'flex' : 'none';
        }

        // 3. éªŒè¯ç™»å½•çŠ¶æ€
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.roleId !== 3) {
            window.location.href = 'login.html';
        }

        // 4. æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        $('#userInfo').text(`æ¬¢è¿ï¼Œ${user.realName}`);

        // 5. é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // 6. GETè¯·æ±‚å·¥å…·å‡½æ•°
        async function fetchGet(url) {
            try {
                const response = await fetch(url, { method: 'GET' }); // å»æ‰å¤šä½™headers
                console.log(`GETè¯·æ±‚çŠ¶æ€ï¼š${response.status}`); // æ–°å¢ï¼šæ‰“å°çŠ¶æ€ç ï¼ˆ404/500ç­‰ï¼‰
                const res = await response.json();
                if (res.code !== 200) throw new Error(res.msg || 'è¯·æ±‚å¤±è´¥');
                return res.data;
            } catch (err) {
                console.error(`GET ${url} å¤±è´¥ï¼š`, err);
                throw err;
            }
        }

        // 7. POSTè¯·æ±‚å·¥å…·å‡½æ•°
        async function fetchPost(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // ä»…ä¿ç•™å¿…è¦çš„JSONå¤´
                    body: JSON.stringify(data)
                });
                console.log(`POSTè¯·æ±‚çŠ¶æ€ï¼š${response.status}`); // æ–°å¢ï¼šæ‰“å°çŠ¶æ€ç 
                const res = await response.json();
                if (res.code !== 200) throw new Error(res.msg || 'è¯·æ±‚å¤±è´¥');
                return res.data;
            } catch (err) {
                console.error(`POST ${url} å¤±è´¥ï¼š`, err);
                throw err;
            }
        }


        // 8. åŠ è½½ç”¨æˆ·å·²é€šè¿‡çš„ç¾æƒ…
        async function loadUserDisasters() {
            showLoading(true);
            try {
                const disasters = await fetchGet(`${apiBaseUrl}/disaster/getDisasterByReportUserId?reportUserId=${user.id}`);
                const approvedDisasters = disasters.filter(d => d.approveStatus === 1);
                const select = $('#disasterSelect');

                if (approvedDisasters.length === 0) {
                    select.append(`<option value="" disabled>æš‚æ— å·²å®¡æ ¸é€šè¿‡çš„ç¾æƒ…ï¼Œè¯·å…ˆä¸ŠæŠ¥ç¾æƒ…å¹¶ç­‰å¾…å®¡æ ¸</option>`);
                    return;
                }

                approvedDisasters.forEach(disaster => {
                    select.append(`<option value="${disaster.id}">${disaster.disasterName}ï¼ˆ${disaster.disasterArea}ï¼‰</option>`);
                });
            } catch (err) {
                console.error('åŠ è½½ç¾æƒ…å¤±è´¥ï¼š', err);
                alert('åŠ è½½ç¾æƒ…åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š' + err.message);
                $('#disasterSelect').append(`<option value="" disabled>ç¾æƒ…åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</option>`);
            } finally {
                showLoading(false);
            }
        }

        // 9. åŠ è½½æ‰€æœ‰ç‰©èµ„ï¼ˆæ–°å¢å¤‡æ³¨åˆ—+æ‹†åˆ†åº“å­˜/è§„æ ¼ï¼‰
        async function loadMaterials() {
            showLoading(true);
            try {
                const materials = await fetchGet(`${apiBaseUrl}/material/getMaterialList`);
                const tableBody = $('#materialTableBody');
                tableBody.empty();

                if (materials.length === 0) {
                    // æ— ç‰©èµ„æ—¶æ˜¾ç¤ºç©ºè¡Œæç¤º
                    tableBody.append(`
                        <tr>
                            <td colspan="8" class="text-center py-3 text-muted">æš‚æ— å¯ç”¨æ•‘æ´ç‰©èµ„</td>
                        </tr>
                    `);
                    return;
                }

                // æ•°æ®æ˜ å°„
                const typeMap = {1: 'å¸ç¯·', 2: 'é£Ÿå“', 3: 'è¯å“', 4: 'å·¥å…·'};
                const priorityMap = {1: 'é«˜', 2: 'ä¸­', 3: 'ä½'};
                // å¤‡æ³¨æ˜ å°„ï¼ˆå¯æ ¹æ®åç«¯å®é™…è¿”å›çš„remarkå­—æ®µè°ƒæ•´ï¼Œæ— åˆ™æ˜¾ç¤ºé»˜è®¤æç¤ºï¼‰
                const getRemark = (material) => {
                    if (material.remark) return material.remark;
                    // æ— å¤‡æ³¨æ—¶æ ¹æ®ç‰©èµ„ç±»å‹æ˜¾ç¤ºé»˜è®¤æç¤º
                    switch(material.materialType) {
                        case 1: return 'å«é˜²æ½®å«ï¼Œé€‚åˆ5äººä»¥å†…ä½¿ç”¨';
                        case 2: return 'ä¿è´¨æœŸ6ä¸ªæœˆï¼Œå¸¸æ¸©å­˜æ”¾';
                        case 3: return 'æ€¥æ•‘å¿…å¤‡ï¼Œæ³¨æ„æœ‰æ•ˆæœŸ';
                        case 4: return 'å«åŸºç¡€ç»´ä¿®å·¥å…·ï¼Œè½»ä¾¿æºå¸¦';
                        default: return 'æ— ç‰¹æ®Šå¤‡æ³¨';
                    }
                };

                // æ¸²æŸ“è¡¨æ ¼è¡Œï¼ˆæ‹†åˆ†åº“å­˜æ•°é‡å’Œè§„æ ¼ï¼Œæ–°å¢å¤‡æ³¨åˆ—ï¼‰
                materials.forEach(material => {
                    tableBody.append(`
                        <tr>
                            <!-- é€‰æ‹©æ¡†åˆ— -->
                            <td>
                                <input type="checkbox" class="form-check-input material-checkbox" id="material-${material.id}" value="${material.id}">
                            </td>
                            <!-- ç‰©èµ„åç§°åˆ— -->
                            <td>
                                <label for="material-${material.id}" class="form-check-label mb-0">${material.materialName}</label>
                            </td>
                            <!-- ç‰©èµ„ç±»å‹åˆ— -->
                            <td>${typeMap[material.materialType] || 'æœªçŸ¥ç±»å‹'}</td>
                            <!-- ä¼˜å…ˆçº§åˆ— -->
                            <td>${priorityMap[material.priorityLevel] || 'æ™®é€š'}</td>
                            <!-- åº“å­˜æ•°é‡åˆ—ï¼ˆä»…æ˜¾ç¤ºæ•°å­—ï¼‰ -->
                            <td>${material.stockNum || 0}</td>
                            <!-- è§„æ ¼åˆ—ï¼ˆå•ç‹¬æ˜¾ç¤ºå•ä½/è§„æ ¼ï¼‰ -->
                            <td>${material.spec || 'æ— '}</td>
                            <!-- å¤‡æ³¨åˆ—ï¼ˆæ–°å¢ï¼‰ -->
                            <td class="text-start" style="padding-left: 1rem;">${getRemark(material)}</td>
                            <!-- ç”³è¯·æ•°é‡åˆ— -->
                            <td>
                                <input type="number" class="form-control material-num" data-id="${material.id}" 
                                       min="1" max="${material.stockNum || 1}" placeholder="è¯·è¾“å…¥æ•°é‡" disabled>
                            </td>
                        </tr>
                    `);
                });

                // å‹¾é€‰æ¡†äº‹ä»¶ï¼šå¯ç”¨/ç¦ç”¨æ•°é‡è¾“å…¥
                $('.material-checkbox').change(function() {
                    const materialId = $(this).val();
                    const numInput = $(`.material-num[data-id="${materialId}"]`);
                    numInput.prop('disabled', !$(this).is(':checked'));
                    if (!$(this).is(':checked')) {
                        numInput.val(''); // å–æ¶ˆå‹¾é€‰æ—¶æ¸…ç©ºè¾“å…¥
                    } else {
                        numInput.focus(); // å‹¾é€‰åè‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                    }
                });
            } catch (err) {
                console.error('åŠ è½½ç‰©èµ„å¤±è´¥ï¼š', err);
                tableBody.append(`
                    <tr>
                        <td colspan="8" class="text-center py-3 text-danger">ç‰©èµ„åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</td>
                    </tr>
                `);
            } finally {
                showLoading(false);
            }
        }

        // 10. è¡¨å•æäº¤ï¼ˆé€‚é…åº“å­˜æ•°é‡æ ¡éªŒï¼‰
       $('#materialApplyForm').submit(async function(e) {
            e.preventDefault();
            const disasterId = $('#disasterSelect').val();
            const targetAddress = $('#targetAddress').val().trim();
            const checked = $('.material-checkbox:checked');

            // å‰ç«¯ç®€å•éªŒè¯ï¼ˆä¿æŒä¸å˜ï¼Œä½†ä¼˜åŒ–æç¤ºæ–‡æ¡ˆï¼‰
            if (!disasterId) { alert('è¯·é€‰æ‹©å…³è”ç¾æƒ…'); return; }
            if (!targetAddress) { alert('è¯·å¡«å†™æ¥æ”¶åœ°å€'); return; }
            if (checked.length === 0) { alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§ç‰©èµ„'); return; }

            // æ„å»ºè®¢å•æ•°æ®ï¼ˆæ ¸å¿ƒï¼šæ·»åŠ userIdå’ŒroleIdï¼Œä¾›åç«¯ç®€å•éªŒè¯ï¼‰
            const orders = [];
            let valid = true;
            checked.each(function() {
                const mId = $(this).val();
                const num = $(`.material-num[data-id="${mId}"]`).val();
                const maxStock = parseInt($(this).closest('tr').find('td:eq(4)').text()) || 1;
                const mName = $(this).closest('tr').find('td:eq(1)').text();

                if (!num || num < 1 || num > maxStock) {
                    alert(`ã€${mName}ã€‘è¯·è¾“å…¥1-${maxStock}ä¹‹é—´çš„æ•°é‡`);
                    valid = false;
                    return false;
                }

                orders.push({
                    userId: user.id,       // ğŸŒŸ æ–°å¢ï¼šä¼ é€’æœ¬åœ°ç”¨æˆ·ID
                    roleId: user.roleId,   // ğŸŒŸ æ–°å¢ï¼šä¼ é€’æœ¬åœ°è§’è‰²IDï¼ˆå¿…é¡»æ˜¯3ï¼‰
                    disasterId: disasterId,
                    materialId: mId,
                    applyNum: parseInt(num),
                    targetAddress: targetAddress,
                    orderStatus: 0 // å¾…å®¡æ ¸
                });
            });

            if (!valid) return;

            showLoading(true);
            try {
                // ğŸŒŸ æ ¸å¿ƒï¼šä¸€æ¬¡æäº¤æ‰€æœ‰è®¢å•ï¼ˆè€Œéå¾ªç¯å¤šæ¬¡è¯·æ±‚ï¼‰
                await fetchPost(`${apiBaseUrl}/order/addOrder`, orders);
                alert('ç”³è¯·æäº¤æˆåŠŸï¼æœ¬åœ°ä½œä¸šæ— éœ€å®¡æ ¸ï¼Œç›´æ¥è·³è½¬è‡³è¿›åº¦é¡µ');
                window.location.href = 'user-order-query.html';
            } catch (err) {
                alert('æäº¤å¤±è´¥ï¼š' + err.message);
            } finally {
                showLoading(false);
            }
        });

        // 11. é¡µé¢åˆå§‹åŒ–ï¼šå¹¶è¡ŒåŠ è½½ç¾æƒ…å’Œç‰©èµ„
        $(document).ready(() => {
            Promise.all([
                loadUserDisasters(),
                loadMaterials()
            ]).catch(err => {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š', err);
            });
        });
    </script>
</body>
</html>