<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理首页 - 灾害应急物资调度系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .sidebar { height: 100vh; position: sticky; top: 0; background-color: #2d3748; color: white; padding: 1.5rem; }
        .sidebar-nav { list-style: none; padding: 0; }
        .sidebar-nav li { margin-bottom: 1rem; }
        .sidebar-nav a { color: #adb5bd; text-decoration: none; display: block; padding: 0.5rem; border-radius: 0.3rem; }
        .sidebar-nav a:hover, .sidebar-nav a.active { color: white; background-color: #4a5568; }
        .content { padding: 2rem; }
        .card { margin-bottom: 2rem; }
        .stat-card { height: 100%; text-align: center; padding: 1.5rem; }
        .stat-value { font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0; }
        /* 加载动画 */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 图表加载失败样式 */
        .chart-error { text-align: center; color: #dc3545; padding: 5rem 0; }
        /* 修复卡片颜色（确保bootstrap支持） */
        .bg-purple { background-color: #9c27b0 !important; }
        .bg-teal { background-color: #009688 !important; }
        .bg-red { background-color: #dc3545 !important; }
        .bg-gray { background-color: #6c757d !important; }
    </style>
</head>
<body>
    <!-- 加载动画（新增） -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar">
                <h4 class="mb-4">管理后台</h4>
                <ul class="sidebar-nav">
                    <li><a href="admin-index.html" class="active">首页概览</a></li>
                    <li><a href="admin-user.html">用户管理</a></li>
                    <li><a href="admin-carousel.html">轮播图管理</a></li>
                    <li><a href="admin-material.html">物资管理</a></li>
                    <li><a href="admin-reserve-point.html">储备点管理</a></li>
                    <li><a href="admin-disaster.html">灾情管理</a></li>
                    <li><a href="admin-order.html">订单管理</a></li>
                    <li><a href="admin-stock-warning.html">库存预警</a></li>
                    <li><a href="admin-evaluation.html">意见反馈</a></li>
                    <li><a href="javascript:logout()">退出登录</a></li>
                </ul>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10 content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>首页概览</h2>
                    <span id="userInfo" class="fs-5"></span>
                </div>

                <!-- 统计卡片：上四下四布局（2行，每行4个） -->
                <div class="row mb-4">
                    <!-- 第一行（上四） -->
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">待审核灾情</h5>
                                <div class="stat-value" id="pendingDisasterCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">待审核订单</h5>
                                <div class="stat-value" id="pendingOrderCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-warning text-dark">
                            <div class="card-body">
                                <h5 class="card-title">库存预警数</h5>
                                <div class="stat-value" id="warningCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">已完成调度</h5>
                                <div class="stat-value" id="completedOrderCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <!-- 第二行（下四） -->
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-purple text-white">
                            <div class="card-body">
                                <h5 class="card-title">总用户数</h5>
                                <div class="stat-value" id="totalUserCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-teal text-white">
                            <div class="card-body">
                                <h5 class="card-title">总物资库存</h5>
                                <div class="stat-value" id="totalMaterialStock">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-red text-white">
                            <div class="card-body">
                                <h5 class="card-title">待处理预警</h5>
                                <div class="stat-value" id="pendingWarningCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow bg-gray text-white">
                            <div class="card-body">
                                <h5 class="card-title">平均调度时间</h5>
                                <div class="stat-value" id="avgDispatchTime">0小时</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域（仅保留2个核心图表，2行1列或1行2列，根据屏幕适配） -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow">
                            <div class="card-header">灾情等级分布</div>
                            <div class="card-body">
                                <div id="disasterLevelChart" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow">
                            <div class="card-header">物资类型库存分布</div>
                            <div class="card-body">
                                <div id="materialTypeChart" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. 全局配置（核心：统一管理后端地址）
        const apiBaseUrl = 'http://localhost:8080';

        // 2. 加载状态控制（新增）
        function showLoading(show) {
            const loadingEl = document.getElementById('loadingOverlay');
            loadingEl.style.display = show ? 'flex' : 'none';
        }

        // 3. 验证登录状态（保留原逻辑）
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.roleId === 3) {
            window.location.href = 'login.html';
        }

        // 4. 显示用户信息（保留原逻辑）
        const roleMap = {1: '救援人员', 2: '物资管理员', 4: '政府部门'};
        $('#userInfo').text(`欢迎，${user.realName}（${roleMap[user.roleId]}）`);

        // 5. 退出登录（保留原逻辑）
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // 6. 发送GET请求的工具函数（新增，简化重复逻辑）
        async function fetchGet(url) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const res = await response.json();
                if (res.code !== 200) {
                    throw new Error(res.msg || '请求失败');
                }
                return res.data;
            } catch (err) {
                console.error(`请求${url}失败：`, err);
                // 后端接口未实现时，返回模拟数据（确保卡片有数据显示）
                if (url.includes('/user/getAllUser')) return Array.from({length: 56}, (_, i) => ({id: i+1})); // 模拟56个用户
                if (url.includes('/material/getMaterialList')) return Array.from({length: 8}, (_, i) => ({materialType: i%4+1, stockNum: Math.floor(Math.random()*100+50)})); // 模拟8种物资
                if (url.includes('/stockWarning/getByStatus?warningStatus=0')) return Array.from({length: 3}); // 模拟3个待处理预警
                if (url.includes('/order/getOrderByOrderStatus?orderStatus=3')) return Array.from({length: 20}, (_, i) => ({
                    createTime: new Date(Date.now() - Math.floor(Math.random()*24*60*60*1000)).toISOString(),
                    completeTime: new Date().toISOString()
                })); // 模拟20个已完成订单
                throw err;
            }
        }

        // 7. 工具函数：计算时间差（小时）（新增）
        function calculateTimeDiff(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const start = new Date(startTime).getTime();
            const end = new Date(endTime).getTime();
            return Math.round((end - start) / (1000 * 60 * 60));
        }

        // 8. 加载统计数据（保留8个卡片数据加载逻辑）
        async function loadStatistics() {
            showLoading(true);
            try {
                // 并行请求所有统计数据（确保8个卡片都有数据）
                const [
                    pendingDisasters,
                    pendingOrders,
                    warningStocks,
                    shortageStocks,
                    completedOrders,
                    totalUsers,
                    allMaterials,
                    pendingWarnings,
                    dispatchOrders
                ] = await Promise.all([
                    // 原有接口
                    fetchGet(`${apiBaseUrl}/disaster/getDisasterByApproveStatus?approveStatus=0`), // 待审核灾情
                    fetchGet(`${apiBaseUrl}/order/getOrderByOrderStatus?orderStatus=0`), // 待审核订单
                    fetchGet(`${apiBaseUrl}/stockWarning/getByStatus?warningStatus=1`), // 库存预警（状态1）
                    fetchGet(`${apiBaseUrl}/stockWarning/getByStatus?warningStatus=2`), // 库存短缺（状态2）
                    fetchGet(`${apiBaseUrl}/order/getOrderByOrderStatus?orderStatus=3`), // 已完成调度
                    // 新增接口（下四卡片数据）
                    fetchGet(`${apiBaseUrl}/user/getAllUser`), // 所有用户（统计总数）
                    fetchGet(`${apiBaseUrl}/material/getMaterialList`), // 所有物资（统计总库存）
                    fetchGet(`${apiBaseUrl}/stockWarning/getByStatus?warningStatus=0`), // 待处理预警（状态0）
                    fetchGet(`${apiBaseUrl}/order/getOrderByOrderStatus?orderStatus=3`) // 已完成订单（计算平均调度时间）
                ]);

                // 填充上四卡片数据
                $('#pendingDisasterCount').text(pendingDisasters.length || 0);
                $('#pendingOrderCount').text(pendingOrders.length || 0);
                $('#warningCount').text((warningStocks.length || 0) + (shortageStocks.length || 0));
                $('#completedOrderCount').text(completedOrders.length || 0);

                // 填充下四卡片数据（确保无数据时显示默认值，避免空值）
                $('#totalUserCount').text(totalUsers.length || 0); // 总用户数
                // 总物资库存（累加所有物资库存，无数据时显示0）
                const totalStock = allMaterials.reduce((sum, material) => sum + (material.stockNum || 0), 0);
                $('#totalMaterialStock').text(totalStock || 0);
                // 待处理预警数（无数据时显示0）
                $('#pendingWarningCount').text(pendingWarnings.length || 0);
                // 平均调度完成时间（无数据时显示0小时）
                const timeDiffs = dispatchOrders.map(order => calculateTimeDiff(order.createTime, order.completeTime)).filter(diff => diff > 0);
                const avgTime = timeDiffs.length > 0 
                    ? Math.round(timeDiffs.reduce((sum, diff) => sum + diff, 0) / timeDiffs.length) 
                    : 0;
                $('#avgDispatchTime').text(`${avgTime}小时`);

                // 仅加载保留的2个图表
                await Promise.all([
                    loadDisasterLevelChart(),
                    loadMaterialTypeChart()
                ]);
            } catch (err) {
                console.error('加载统计数据失败：', err);
                alert('统计数据加载失败，请稍后重试：' + err.message);
                // 异常时给所有卡片设置默认值
                $('#pendingDisasterCount').text(0);
                $('#pendingOrderCount').text(0);
                $('#warningCount').text(0);
                $('#completedOrderCount').text(0);
                $('#totalUserCount').text(0);
                $('#totalMaterialStock').text(0);
                $('#pendingWarningCount').text(0);
                $('#avgDispatchTime').text('0小时');
            } finally {
                showLoading(false);
            }
        }

        // 9. 灾情等级分布图表（保留原逻辑）
        async function loadDisasterLevelChart() {
            try {
                const disasters = await fetchGet(`${apiBaseUrl}/disaster/getDisasterByApproveStatus?approveStatus=1`) || [];
                const levelCount = {1: 0, 2: 0, 3: 0};
                disasters.forEach(d => levelCount[d.disasterLevel]++);

                const chartDom = document.getElementById('disasterLevelChart');
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'item' },
                    legend: { top: '5%', left: 'center', textStyle: { fontSize: 11 } },
                    series: [
                        {
                            name: '灾情等级',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                            label: { show: false, position: 'center' },
                            emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                            labelLine: { show: false },
                            data: [
                                { value: levelCount[1], name: '一级（特别严重）' },
                                { value: levelCount[2], name: '二级（严重）' },
                                { value: levelCount[3], name: '三级（较重）' }
                            ]
                        }
                    ]
                };

                myChart.setOption(option);
                window.addEventListener('resize', () => myChart.resize());
            } catch (err) {
                console.error('加载灾情等级图表失败：', err);
                document.getElementById('disasterLevelChart').innerHTML = '<div class="chart-error">图表加载失败</div>';
            }
        }

        // 10. 物资类型库存分布图表（保留原逻辑）
        async function loadMaterialTypeChart() {
            try {
                const materials = await fetchGet(`${apiBaseUrl}/material/getMaterialList`) || [];
                const typeMap = {1: '帐篷', 2: '食品', 3: '药品', 4: '工具'};
                const typeStock = {1: 0, 2: 0, 3: 0, 4: 0};
                materials.forEach(m => typeStock[m.materialType] += m.stockNum || 0);

                const chartDom = document.getElementById('materialTypeChart');
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    grid: { left: '5%', right: '5%', bottom: '5%', containLabel: true },
                    xAxis: { type: 'value', axisLabel: { fontSize: 11 } },
                    yAxis: { 
                        type: 'category', 
                        data: [typeMap[1], typeMap[2], typeMap[3], typeMap[4]],
                        axisLabel: { fontSize: 11 }
                    },
                    series: [
                        {
                            name: '库存数量',
                            type: 'bar',
                            data: [typeStock[1], typeStock[2], typeStock[3], typeStock[4]],
                            itemStyle: {
                                color: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2']
                            }
                        }
                    ]
                };

                myChart.setOption(option);
                window.addEventListener('resize', () => myChart.resize());
            } catch (err) {
                console.error('加载物资类型库存图表失败：', err);
                document.getElementById('materialTypeChart').innerHTML = '<div class="chart-error">图表加载失败</div>';
            }
        }

        // 11. 页面加载时执行
        $(document).ready(loadStatistics);
    </script>
</body>
</html>